name: SonarCloud Python Analysis

on:
  push:
    branches:
      - main
      - development
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      # 2. Configurar o Ambiente Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 
      
      # 3. Instalar Dependências (pytest-cov para gerar o relatório de cobertura)
      - name: Install Python Dependencies
        # Entra na pasta API para garantir que o pip e o poetry funcionam corretamente se forem usados.
        run: |
          python -m pip install --upgrade pip
          # Instala as dependências do  projeto, incluindo pytest e pytest-cov
          pip install pytest pytest-cov
          # Se o seu projeto tiver um ficheiro requirements.txt na pasta 'api':
          # pip install -r api/requirements.txt
      
      # 4. Executar Testes e Gerar Relatório de Cobertura
      - name: Run Tests and Generate Coverage Report
        # O comando é executado a partir da raiz do repositório
        run: |
          # Navega para a pasta 'api' onde o código e os testes residem
          cd api
          # Executa os testes usando pytest, gera o relatório de cobertura e guarda-o na raiz do repositório (../coverage.xml)
          pytest --cov-report xml:../coverage.xml --cov=src # --cov=src aponta para a pasta do seu código fonte dentro de 'api'
          
      # 5. Executar o Sonar Scanner
      # O scanner irá ler automaticamente:
      # - O ficheiro sonar-project.properties (para a chave/organização)
      # - O ficheiro coverage.xml (que foi gerado no passo 4)
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}